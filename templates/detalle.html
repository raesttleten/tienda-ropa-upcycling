<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ producto.nombre }} - thriftstorecol</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <nav>
            <a href="/" class="logo">thriftstorecol</a>

            <div class="nav-icons">
                <form action="/buscar" method="get" class="search-bar">
                    <input type="text" name="q" placeholder="Buscar...">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </form>

                <a href="/" title="Inicio">
                    <i class="fas fa-home"></i>
                </a>
                <a href="/carrito" title="Carrito">
                    <i class="fas fa-shopping-bag"></i>
                    <span id="carrito-badge" class="badge-carrito" style="display: none;">0</span>
                </a>
                <a href="#" title="Mi Cuenta" id="miCuentaLink">
                    <i class="fas fa-user"></i>
                </a>
            </div>
        </nav>
    </header>

    <div class="categorias">
        <div class="categorias-inner">
            <a href="/categoria/Camisas" class="categoria-btn">Camisas</a>
            <a href="/categoria/Pantalones" class="categoria-btn">Pantalones</a>
            <a href="/categoria/Faldas" class="categoria-btn">Faldas</a>
            <a href="/categoria/Bolsos" class="categoria-btn">Bolsos</a>
            <a href="/categoria/Accesorios" class="categoria-btn">Accesorios</a>
        </div>
    </div>

    <main>
        <div class="detalle-container">
            <div class="detalle-producto">
                <div class="detalle-imagen">
                    <img src="{{ producto.imagen_url }}" alt="{{ producto.nombre }}" onerror="this.src='https://images.unsplash.com/photo-1445205170230-053b83016050?w=800&h=1000&fit=crop'">
                </div>

                <div class="detalle-info">
                    <span class="categoria">{{ producto.categoria }}</span>
                    <h2>{{ producto.nombre }}</h2>

                    <p class="descripcion">{{ producto.descripcion }}</p>

                    <div class="precio">${{ producto.precio|format_cop }} COP</div>

                    <div class="detalle-specs">
                        <div class="spec-item">
                            <i class="fas fa-tag"></i>
                            <span>Talla: {{ producto.talla }}</span>
                        </div>
                        <div class="spec-item">
                            <i class="fas fa-box"></i>
                            <span>Stock: {{ producto.stock }} {% if producto.stock == 1 %}pieza{% else %}piezas{% endif %}</span>
                        </div>
                        {% if producto.stock == 1 %}
                        <div class="spec-item unique">
                            <i class="fas fa-star"></i>
                            <span>PIEZA ÚNICA</span>
                        </div>
                        {% endif %}
                    </div>

                    {% if producto.stock > 0 %}
                    <div class="detalle-acciones">
                        <button onclick="agregarAlCarrito('{{ producto.id }}')" class="btn-comprar" id="btnAgregar">
                            <i class="fas fa-shopping-bag"></i> Agregar al Carrito
                        </button>
                        <button onclick="comprarAhora('{{ producto.id }}')" class="btn-comprar-ahora">
                            <i class="fas fa-bolt"></i> Comprar Ahora
                        </button>
                    </div>
                    {% else %}
                    <div class="producto-agotado">
                        <i class="fas fa-times-circle"></i>
                        <span>Producto Agotado</span>
                    </div>
                    {% endif %}

                    <div class="detalle-info-adicional">
                        <div class="info-adicional-item">
                            <i class="fas fa-recycle"></i>
                            <div>
                                <strong>Moda Sostenible</strong>
                                <p>Pieza upcycling única y exclusiva</p>
                            </div>
                        </div>
                        <div class="info-adicional-item">
                            <i class="fas fa-truck"></i>
                            <div>
                                <strong>Envío Gratis</strong>
                                <p>En todas las compras</p>
                            </div>
                        </div>
                        <div class="info-adicional-item">
                            <i class="fas fa-shield-alt"></i>
                            <div>
                                <strong>Pago Seguro</strong>
                                <p>Proceso de pago protegido</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productos Relacionados -->
            {% if productos_relacionados %}
            <div class="productos-relacionados">
                <h3>Productos Relacionados</h3>

                <div class="productos-grid">
                    {% for relacionado in productos_relacionados %}
                    <div class="producto-card">
                        <div class="producto-img-container">
                            <img src="{{ relacionado.imagen_url }}" alt="{{ relacionado.nombre }}" onerror="this.src='https://images.unsplash.com/photo-1445205170230-053b83016050?w=500&h=600&fit=crop'">

                            <div class="producto-badges">
                                {% if relacionado.stock == 1 %}
                                <span class="badge nuevo">ÚNICA PIEZA</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="producto-info">
                            <span class="categoria">{{ relacionado.categoria }}</span>
                            <h4>{{ relacionado.nombre }}</h4>
                            <span class="talla">Talla: {{ relacionado.talla }}</span>
                            <p class="precio">${{ relacionado.precio|format_cop }} COP</p>

                            <div class="producto-actions">
                                <button onclick="agregarAlCarrito('{{ relacionado.id }}')" class="btn-add-cart">
                                    <i class="fas fa-shopping-bag"></i> Agregar
                                </button>
                                <a href="/producto/{{ relacionado.id }}" class="btn-primary">Ver Detalles</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </main>

    <footer>
        <p>thriftstorecol</p>
        <p style="margin-top: 0.5rem;">Moda Vintage · Sostenible · Única</p>
    </footer>

    <script>
        const productoId = ('{{ producto.id }}');
        const productoStock = ('{{ producto.stock }}');

        // ==================== VERIFICAR AUTENTICACIÓN ====================
        async function verificarAutenticacion() {
            try {
                const response = await fetch('/api/auth/usuario-actual');
                const data = await response.json();

                if (data.autenticado) {
                    document.getElementById('miCuentaLink').href = '/mi-cuenta';

                    // Cargar cantidad de items en carrito
                    const carritoResponse = await fetch('/api/carrito');
                    if (carritoResponse.ok) {
                        const carritoData = await carritoResponse.json();
                        if (carritoData.total_items > 0) {
                            const badge = document.getElementById('carrito-badge');
                            badge.textContent = carritoData.total_items;
                            badge.style.display = 'block';
                        }
                    }
                } else {
                    document.getElementById('miCuentaLink').href = '/login';
                }
            } catch (error) {
                document.getElementById('miCuentaLink').href = '/login';
            }
        }

        // ==================== AGREGAR AL CARRITO ====================
        async function agregarAlCarrito(productoId) {
            const btnAgregar = document.getElementById('btnAgregar');

            if (btnAgregar) {
                btnAgregar.disabled = true;
                btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
            }

            try {
                const formData = new FormData();
                formData.append('producto_id', productoId);
                formData.append('cantidad', 1);

                const response = await fetch('/api/carrito/agregar', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // Actualizar badge del carrito
                    const badge = document.getElementById('carrito-badge');
                    badge.textContent = data.total_items;
                    badge.style.display = 'block';

                    // Mostrar notificación
                    mostrarNotificacion('¡Producto agregado al carrito!', 'success');

                    if (btnAgregar) {
                        btnAgregar.innerHTML = '<i class="fas fa-check"></i> Agregado';
                        setTimeout(() => {
                            btnAgregar.disabled = false;
                            btnAgregar.innerHTML = '<i class="fas fa-shopping-bag"></i> Agregar al Carrito';
                        }, 2000);
                    }
                } else if (response.status === 401) {
                    // No autenticado
                    mostrarNotificacion('Debes iniciar sesión para agregar productos', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                } else {
                    mostrarNotificacion(data.detail || 'Error al agregar producto', 'error');
                    if (btnAgregar) {
                        btnAgregar.disabled = false;
                        btnAgregar.innerHTML = '<i class="fas fa-shopping-bag"></i> Agregar al Carrito';
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al agregar producto', 'error');
                if (btnAgregar) {
                    btnAgregar.disabled = false;
                    btnAgregar.innerHTML = '<i class="fas fa-shopping-bag"></i> Agregar al Carrito';
                }
            }
        }

        // ==================== COMPRAR AHORA ====================
        async function comprarAhora(productoId) {
            try {
                const formData = new FormData();
                formData.append('producto_id', productoId);
                formData.append('cantidad', 1);

                const response = await fetch('/api/carrito/agregar', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // Redirigir a checkout
                    window.location.href = '/checkout';
                } else if (response.status === 401) {
                    mostrarNotificacion('Debes iniciar sesión', 'error');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                } else {
                    const data = await response.json();
                    mostrarNotificacion(data.detail || 'Error', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al procesar la compra', 'error');
            }
        }

        // ==================== NOTIFICACIONES ====================
        function mostrarNotificacion(mensaje, tipo) {
            const notif = document.createElement('div');
            notif.className = `notificacion notificacion-${tipo}`;
            notif.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${mensaje}</span>
            `;

            document.body.appendChild(notif);

            setTimeout(() => notif.classList.add('show'), 100);

            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Verificar autenticación al cargar
        verificarAutenticacion();
    </script>
</body>
</html>